---
title: "AmazonLinux2023上でSquidフォワードプロキシ(SSL Bump)を構築してみた"
emoji: "🌟"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["aws","proxy","squid"]
published: false
---
みなさんはProxyを構築したことはありますか？
社内Proxyに阻まれた方は多いかと思いますが、あまり実際に構築したことがある方は多くないのかなと思います。さらに、SSL通信を透過するプロキシ(Transparent Proxy)に関しては関連記事もあまりないので、自分自身の備忘としても残しておこうと思います。

:::message alert
なお、透過的プロキシはSSLの中間者攻撃と同等の構成になるため、構築に関しては関係者との合意と明確な通信経路上で行うようにしましょう。
:::


# はじめに
今回はAWSの***AmazonLinux2023***のイメージを使ってフォワードプロキシを構築します。
EC2を構築したことはあるが、Proxyを構築したことがないという方に向けてまとめていこうと思います。また、通常のHTTPプロキシではなく、HTTPS通信に対応したSSL Bumpを実装します。この部分の記事が少ないのでぜひ参考にしていただければと思います。


# Squidとは
そもそも[Squid](https://www.squid-cache.org/)とは、オープンソースで提供されているプロキシサーバーやウェブキャッシュサーバーを実装するためのソフトウェアです。マルチOSで稼働でき、GNU GPLライセンス下で利用できます。

HTTP通信に限らず、HTTPSやFTPなどの様々なプロトコルに対応しており、プロキシサーバーとしては非常に多くのシェアを持っています。
Squidのプロキシモードとしては4つあります。
1. フォワーディングプロキシ
2. 多段プロキシ
3. リバースプロキシ
4. 透過的プロキシ

## フォワーディングプロキシ
内部NW(LAN)から外部NW(WAN)への通信を中継するための機能です。最もメインの機能になるかと思います。
特定ドメインへのアクセス許可(ホワイトリスト)やアクセス拒否(ブラックリスト)の制御が可能です。

## 多段プロキシ
単一のプロキシで完結せず、内部の通信であれば別の社内プロキシに転送するような制御を行うための機能です。
特定のアクセス先のものを次段のプロキシに転送して外部Saasと連携する(ex:ウイルスチェック)ような動作も実装可能です。

## リバースプロキシ
外部NWから内部NWに通信を受ける際に、代表のエンドポイントとして動作しアクセスを中継する機能です。
内部のWEBサーバーの負荷分散やURLでの振り分けを行うような動作が可能です。また、SSL/TLSオフロード実装も可能なので、SSL終端として証明書を1つに集約することも可能です。

## 透過的プロキシ
利用者がプロキシの存在を意識せずプロキシを利用できる機能です。通常はOSやアプリケーションにプロキシ情報を登録する必要がありますが、透過的プロキシは指定せずともアクセス経路上のプロキシを自動的に通っていくので、利用者が意識せず通信制御を実装することが可能です。

## アクセス制御方式
ドメインリストやIPアドレスリストを用いてACLを設定して、アクセス許可/拒否を行います。さらに外部の認証機構と連携することも可能ですので、既存のユーザー管理システムと連携してユーザー認証を実装することも可能です。


# AmazonLinux2023の注意点
今回はOSにAmazonLinux2023を利用するのですが、その際にいくつかはまりポイントがありましたのでまとめておこうと思います。
これはSquidに限らず影響しますので、ご参考にしていただければと思います。

1. パッケージ管理
2. 



# 手順
EC2の構築のために、VPCにPublicサブネット(NATGW)とPrivateサブネット(検証用インスタンス)を構築した状態で、新規サブネットにProxyサーバーを構築していきます。

![アーキテクチャー図](/images/aws-squid-proxy/01-architecture.png)

今回は以下のドメインで検証してみます。なお、各インスタンスにはSSMセッションマネージャーを利用してアクセスしていますので、インスタンスプロファイルには`AmazonSSMManagedInstanceCore`を設定しておきます。
* アクセス許可
  https://www.google.com
* アクセス拒否
  https://www.yahoo.co.jp

また、環境構築にはTerraformを用いています。コードはこちらをご参照ください。
:::details terraformインストール
https://developer.hashicorp.com/terraform/install

```bash
sudo yum install -y yum-utils shadow-utils
sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo
sudo yum -y install terraform
```
:::

::: 基本環境

:::

## 環境構築
まずは①の経路でインターネットへのアクセスが可能かを確認していきます。
App Instanceサブネットのデフォルトルート(0.0.0.0/0向け)をNAT GatewayのIDに設定しておきます。そうするとNAT Gateway経由でインターネットアクセスが可能です。

```bash
sh-5.2$ curl "https://www.google.com" -o /dev/null -w '%{http_code}\n' -s
200

sh-5.2$ curl "https://www.yahoo.co.jp" -o /dev/null -w '%{http_code}\n' -s
200
```

## Proxy Instance構築





# さいごに


