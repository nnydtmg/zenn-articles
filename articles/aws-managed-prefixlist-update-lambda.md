---
title: "AWS管理のIPが更新された時にプレフィックスリストに登録しいているIPレンジを自動更新する"
emoji: "😸"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["aws","python","lambda","waf"]
published: false
---

# はじめに

皆さんはプレフィックスリスト利用していますか？

私はNetworkFirewallのアウトバウンドを厳密に制限する必要がある時に初めて使いました。さらに、Amazon WorkSpacesクライアントアプリを利用した通信ということで、様々なAWS管理のアドレス帯への要件がありました。

が、これがなかなか面倒で、不定期にAWS側でレンジの切り替えがあり、その都度設定しているプレフィックスリストを更新する必要が出てきました。
毎度手動で更新しても良いですが、数百のレンジに対して差分確認・更新作業は非現実的でした。

そこで、IPレンジが更新された時に自動的にプレフィックスリストを更新する仕組みを作ってみました。

参考程度にコードも載せておきますので、カスタマイズして使ってみてください。インフラ屋のコードなので全く整っていないですが、ご了承ください。。


# マネージドプレフィックスリストとは

そもそもプレフィックスリストとは何かから。

[ドキュメント](https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/managed-prefix-lists.html)には以下のように記載されています。

> マネージドプレフィックスリストは、1 つ以上の CIDR ブロックのセットです。プレフィクスリストを使用すると、セキュリティグループとルートテーブルの設定と管理が容易になります。頻繁に使用する IP アドレスからプレフィクスリストを作成し、それらを個別に参照するのではなく、セキュリティグループのルールおよびルートでセットとして参照できます。例えば、CIDR ブロックは異なるが同じポートとプロトコルを持つセキュリティグループルールを、プレフィクスリストを使用する 1 つのルールに統合できます。ネットワークを拡張し、別の CIDR ブロックからのトラフィックを許可する必要がある場合は、関連するプレフィクスリストを更新し、プレフィクスリストを使用するすべてのセキュリティグループを更新します。Resource Access Manager (RAM) を使用して、他の AWS アカウントでマネージドプレフィックスリストを使用することもできます。

さらに、プレフィックスリストには２種類あります。

> * カスタマー管理プレフィクスリスト ：定義および管理する IP アドレス範囲のセット。プレフィックスリストは、他の AWS アカウントと共有できます。そのアカウントはそのリソース内で、このプレフィックスリストを参照できます。
> 
> * AWS マネージドプレフィクスリスト — AWS サービスの IP アドレス範囲のセット。AWS マネージドプレフィックスリストを作成、変更、共有、削除することはできません。

今回は、WorkSpacesに関するIPアドレス帯をカスタマー管理プレフィックスリストで管理しています。

そして、なぜ使わないといけなくなったかというと、
通常WorkSpacesを利用する方は特に気にする必要はないのですが、業務上アウトバウンドに制限をかける必要があり、proxyを通すか




